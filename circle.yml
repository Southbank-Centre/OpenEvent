machine:
  php:
    version: 5.5.11

  # Override /etc/hosts
  hosts:
    sc.circle: 127.0.0.1
    api.sc.circle: 127.0.0.1

dependencies:
  pre:

    # Install Drush.
    - composer global require --prefer-source --no-interaction drush/drush:6.2.0

  # Install additional test dependencies here (like Casper, Behat, etc).
  override:
    - sudo cp $HOME/southbankcentre.org-CMS/drupal/sites/default/settings.php $HOME/southbankcentre.org-CMS/drupal/sites/default/settings.php.ci
    # This step should install the Open Event profile when it has been created
    # I.e. ... site-install OpenEvent -y --account-mail= ...
    - drush -r $HOME/southbankcentre.org-CMS/drupal make local-openevent.make -y
    - PHP_OPTIONS="-d sendmail_path=/bin/true" drush -r $HOME/southbankcentre.org-CMS/drupal site-install openevent -y --account-mail=alexb@cogapp.com --account-name=admin --account-pass=admin --db-url=mysql://ubuntu@127.0.0.1/circle_test
    - sudo cp $HOME/southbankcentre.org-CMS/drupal/sites/default/local.settings.php.ci $HOME/southbankcentre.org-CMS/drupal/sites/default/local.settings.php
    - drush -r $HOME/southbankcentre.org-CMS/drupal en -y master
    - drush -r $HOME/southbankcentre.org-CMS/drupal master-execute -y --scope=dev
    # Features module isn't currently installed, but will be when Open Event profile has been created
    #- drush -r $HOME/southbankcentre.org/drupal fra -y
    - drush -r $HOME/southbankcentre.org-CMS/drupal cc all

  post:
    # apache module setup
    - a2enmod rewrite
    # apache vhost setup
    - cp $HOME/southbankcentre.org-CMS/ci/api.vhost /etc/apache2/sites-available/api
    - a2ensite api
    - sudo service apache2 restart
    # protractor setup
    - npm install -g protractor@1.8.0
    # frisby setup
    - npm install -g frisby@0.8.5
    - npm link frisby
    # saucelabs setup
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz

test:
  override:
    - ./bin/sc -u $SAUCE_USERNAME -k $SAUCE_ACCESS_KEY -f ~/sc_ready:
        background: true
        pwd: sc-*-linux
    # Wait for tunnel to be ready
    - while [ ! -e ~/sc_ready ]; do sleep 1; done
    - node run_suites_synchronously --params.url 'http://api.sc.circle:8080'

general:
  branches:
    only:
      # only build develop, master and release branches
      - develop
      - master
      - /release-.*/
      - 91510332_cms_architecture
